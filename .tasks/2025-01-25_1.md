# Context
Task file name: 2025-01-25_1
Created at: 2025-01-25_07:30:00
Created by: subhajlimanond
Main branch: task/location-data-population_2025-01-22_3
Task Branch: task/location-data-population_2025-01-22_3
YOLO MODE: on

# Task Description
Fix geocoding errors in location data update script:
1. Fix Thai character encoding issues in Google Maps API queries
2. Improve error handling and logging
3. Optimize geocoding query construction for Thai addresses
4. Add data validation for coordinates returned from API

# Project Overview
A social monitoring and automated response generation platform for severe water-related incidents such as flooding, drought, as well as other generic questions and requests for the Royal Irrigation Department (RID) of Thailand. The project uses Next.js for the frontend and Node.js with PostgreSQL for the backend. The location data is crucial for mapping and analyzing water-related incidents across Thailand.

# Task Analysis
- Purpose: Fix geocoding errors in location data update script
- Issues identified:
  - Thai character encoding corruption: `ศาลากลางจังหวัดà ̧. à ̧aà ̧à ̧1à ̧¥`
  - Insufficient error logging in geocoding failures
  - Query construction might need optimization
  - Need better validation of returned coordinates
- Implementation goals:
  1. Fix Thai character encoding
  2. Enhance error logging
  3. Optimize query construction
  4. Add coordinate validation

# Task Analysis Tree
```
apps/backend/src/scripts/
├── update_location_data.ts       # Main script to fix
├── test_update_location.ts       # Test script for fixes
└── import_location_data.ts       # Related data import script

apps/backend/src/services/
└── location.service.ts           # Location service using Mapbox

Database Tables:
├── provinces
│   ├── id
│   ├── name_th
│   ├── name_en
│   ├── latitude
│   └── longitude
└── amphures
    ├── id
    ├── province_id
    ├── name_th
    ├── name_en
    ├── latitude
    └── longitude
```

# Steps to take
1. Fix Thai character encoding in query strings
2. Enhance error logging with detailed error information
3. Optimize query construction for Thai addresses
4. Add coordinate validation
5. Test fixes with sample data
6. Update documentation

# Current execution step: 1

# Important Notes
- Need to handle Thai character encoding properly
- Should log detailed error information
- Consider rate limits and retry strategies
- Verify coordinates are valid for Thailand

# Task Progress
2025-01-25_07:30:00 - IN_PROGRESS
- Identified issues in geocoding script:
  - Thai character encoding corruption
  - Insufficient error logging
  - Query construction needs optimization
  - Missing coordinate validation

2025-01-25_07:45:00 - IN_PROGRESS
- Analyzed current implementation:
  - Main service uses Mapbox for regular geocoding
  - Update scripts use Google Maps API for database updates
  - Found encoding issues in query construction
  - Identified areas for improved error handling

2025-01-25_08:00:00 - SUCCESSFUL
- Implemented fixes for Thai character encoding and geocoding issues:
  - Added normalizeThaiText() function to handle Thai character encoding
  - Created constructSearchQuery() function for consistent query formatting
  - Added validateCoordinates() to ensure coordinates are within Thailand
  - Enhanced error logging with query details
  - Added proper UTF-8 headers to API requests
  - Improved query construction with region and language parameters
  - Added coordinate validation before updates
  - Cleaned up logging for better debugging

2025-01-25_08:15:00 - SUCCESSFUL
- Updated TypeScript configuration for ES modules:
  - Changed module setting to "ES2020" to support import.meta
  - Added allowJs, resolveJsonModule, and isolatedModules options
  - Maintained strict type checking and other best practices
  - Fixed linter errors in update_location_data.ts

2025-01-25_08:30:00 - SUCCESSFUL
- Created comprehensive test suite:
  - Added test script with sample dataset
  - Implemented tests for Thai text normalization
  - Added query construction tests
  - Created coordinate validation tests
  - Added geocoding integration tests
  - Exported helper functions for testing
  - Added detailed logging for test results

2025-01-25_08:45:00 - SUCCESSFUL
- Executed test suite and verified results:
  - Thai text normalization working correctly
  - Query construction generating proper formats
  - Coordinate validation correctly identifying Thai bounds
  - Geocoding successfully retrieving coordinates
  - All test cases passing with proper logging
  - Fixed script execution with tsx

# Next Steps
1. Monitor coordinate updates in production
2. Update documentation with the changes

# Important Notes
- Thai character encoding must be UTF-8
- Error logs should include API response details
- Query strings should follow Thai address conventions
- All coordinates must be within Thailand's bounds
- TypeScript is configured for ES modules
- Test suite includes sample data from different regions
- All test cases are passing successfully

# Final Review
[To be filled in when complete] 