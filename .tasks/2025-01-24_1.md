# Context
Task file name: 2025-01-24_1
Created at: 2025-01-24_15:45:00
Created by: subhajlimanond
Main branch: task/location-data-population_2025-01-22_3
Task Branch: task/location-data-population_2025-01-22_3
YOLO MODE: on

# Task Description
Update location data in the database with accurate coordinates:
1. Update Province table with coordinates of 'ศาลากลางจังหวัด' (Provincial Halls) for provinces and 'ศาลาว่าการกรุงเทพมหานคร' (Bangkok City Hall) for Bangkok
2. Update Amphure table with coordinates of 'ที่ว่าการอำเภอ' (District Offices) for provinces and 'สำนักงานเขต' (District Offices) for Bangkok

# Project Overview
A social monitoring and automated response generation platform for severe water-related incidents such as flooding, drought, as well as other generic questions and requests for the Royal Irrigation Department (RID) of Thailand. The project uses Next.js for the frontend and Node.js with PostgreSQL for the backend. The location data is crucial for mapping and analyzing water-related incidents across Thailand.

# Original Execution Protocol
[The entire execution protocol is preserved in the task file but omitted here for brevity]

# Task Analysis
- Purpose: Improve accuracy of location data by using official government building coordinates
- Issues identified:
  - Current amphure coordinates are using tumbon data points
  - Province coordinates need to be updated to use provincial halls
  - Need accurate district office locations for better geographic reference
- Implementation goals:
  1. Create script to update province coordinates
  2. Create script to update amphure coordinates
  3. Verify data accuracy after updates

# Task Analysis Tree
```
apps/backend/src/scripts/
├── import_location_data.ts       # Current data import script
├── add_location_indexes.ts       # B-tree indexes for coordinates
├── check_location_data.ts        # Data verification script
└── update_location_data.ts       # New script for coordinate updates

apps/backend/src/services/
└── location.service.ts           # Location data service

Database Tables:
├── provinces
│   ├── id
│   ├── name_th
│   ├── name_en
│   ├── latitude
│   └── longitude
└── amphures
    ├── id
    ├── province_id
    ├── name_th
    ├── name_en
    ├── latitude
    └── longitude
```

# Steps to take
1. Create script to fetch coordinates from Google Maps API
2. Update province coordinates with provincial hall locations
3. Update amphure coordinates with district office locations
4. Verify coordinate updates
5. Update documentation

# Current execution step: 4

# Important Notes
- Need to handle Bangkok differently (use city hall and district offices)
- Should preserve existing coordinates as backup
- Consider rate limits of mapping APIs
- Verify all coordinates fall within Thailand's bounds

# Task Progress
2025-01-24_15:45:00 - SUCCESSFUL
- Created task file
- Analyzed current location data structure
- Identified files and tables that need updates

2025-01-24_16:00:00 - SUCCESSFUL
- Installed Google Maps API client (@googlemaps/google-maps-services-js)
- Created update_location_data.ts script with functions to:
  - Update province coordinates using provincial halls
  - Update amphure coordinates using district offices
  - Backup original coordinates in separate tables
  - Verify coordinates are within Thailand's bounds
- Added update-location-data script to package.json

2025-01-24_16:15:00 - SUCCESSFUL
- Added GOOGLE_MAPS_API_KEY to environment variables
- Created .env.example file with all required environment variables
- Updated documentation with environment setup requirements

2025-01-24_16:30:00 - SUCCESSFUL
- Created GOOGLE_MAPS_API_SETUP.md guide with:
  - Step-by-step instructions for setting up GCP project
  - Process for enabling Geocoding API
  - Security best practices for API key
  - Usage monitoring and troubleshooting tips

# Next Steps
1. Get a valid Google Maps API key (follow GOOGLE_MAPS_API_SETUP.md)
2. Run the script to update coordinates
3. Verify the updated coordinates
4. Update documentation with the changes made

# Important Notes
- The Google Maps API key must have Geocoding API enabled
- The script includes rate limiting (200ms delay between requests) to respect Google Maps API quotas
- Original coordinates are backed up in separate tables before updates
- All coordinates are verified to be within Thailand's bounds
- Estimated API usage:
  - Provinces: 77 requests
  - Amphures: 928 requests
  - Total: 1,005 requests (well within free tier limit of 40,000/month)

# Final Review
[To be filled in when complete] 